<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker with PIN</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      transition: background 0.3s, color 0.3s;
    }
    button, input, textarea {
      padding: 10px 15px;
      margin: 5px 0;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    .dark {
      background: #121212;
      color: #e0e0e0;
    }
    .dark input, .dark button, .dark textarea {
      background: #1e1e1e;
      color: white;
      border: 1px solid #333;
    }
    .log, .summary, .breaks, .task-note { margin-top: 20px; }
    .overtime { color: red; font-weight: bold; }
    #pinSetup, #lockScreen, #app { margin-top: 30px; }
  </style>
</head>
<body>
  <h2>üîí Time Tracker</h2>

  <!-- PIN Setup -->
  <div id="pinSetup" style="display:none;">
    <p>Create a new PIN:</p>
    <input type="password" id="newPin" placeholder="Enter new PIN" maxlength="10" />
    <input type="password" id="confirmPin" placeholder="Confirm new PIN" maxlength="10" />
    <button onclick="setNewPin()">Set PIN</button>
  </div>

  <!-- PIN Login -->
  <div id="lockScreen" style="display:none;">
    <p>Enter your PIN to unlock:</p>
    <input type="password" id="pinInput" placeholder="Enter PIN" maxlength="10" />
    <button onclick="checkPIN()">Unlock</button>
  </div>

  <!-- Main App -->
  <div id="app" style="display:none;">
    <button onclick="startWork()">Start Work</button>
    <button onclick="endWork()">End Work</button>

    <div class="breaks">
      <button onclick="startBreak()">Start Break</button>
      <button onclick="endBreak()">End Break</button>
    </div>

    <div class="task-note">
      <textarea id="taskNote" placeholder="Enter task note..."></textarea>
      <button onclick="saveNote()">Save Note</button>
    </div>

    <div class="log">
      <p><strong>Start Time:</strong> <span id="startTime">--:--</span></p>
      <p><strong>End Time:</strong> <span id="endTime">--:--</span></p>
      <p><strong>Total Break Time:</strong> <span id="breakTotal">--</span></p>
      <p><strong>Today's Total:</strong> <span id="dailyTotal">--</span></p>
    </div>

    <div class="summary">
      <h3>üóì Weekly Total: <span id="weeklyTotal">--</span> <span id="overtime"></span></h3>
    </div>

    <button onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
    <button onclick="resetCurrentWeek()">üóì Reset This Week</button>
    <button onclick="clearData()">üóë Clear All Data</button>
    <button onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>
  </div>

  <script>
    // Initial PIN Setup
    if (!localStorage.getItem("userPin")) {
      document.getElementById("pinSetup").style.display = "block";
    } else {
      document.getElementById("lockScreen").style.display = "block";
    }

    function setNewPin() {
      const pin1 = document.getElementById("newPin").value.trim();
      const pin2 = document.getElementById("confirmPin").value.trim();
      if (!pin1 || !pin2) {
        alert("Please fill both fields.");
        return;
      }
      if (pin1 !== pin2) {
        alert("PINs do not match!");
        return;
      }
      localStorage.setItem("userPin", pin1);
      alert("PIN set! Please log in.");
      document.getElementById("pinSetup").style.display = "none";
      document.getElementById("lockScreen").style.display = "block";
    }

    function checkPIN() {
      const entered = document.getElementById("pinInput").value.trim();
      const savedPin = localStorage.getItem("userPin");
      if (entered === savedPin) {
        document.getElementById("lockScreen").style.display = "none";
        document.getElementById("app").style.display = "block";
        updateDisplay();
      } else {
        alert("Incorrect PIN.");
      }
    }

    // Helpers
    const formatTime = (d) => d.toTimeString().split(' ')[0].slice(0,5);
    const getTodayKey = () => new Date().toISOString().slice(0,10);

    // Main time tracking
    function startWork() {
      const now = new Date();
      localStorage.setItem(`${getTodayKey()}_start`, now.toISOString());
      updateDisplay();
    }

    function endWork() {
      const now = new Date();
      localStorage.setItem(`${getTodayKey()}_end`, now.toISOString());
      updateDisplay();
    }

    function startBreak() {
      const now = new Date();
      localStorage.setItem(`${getTodayKey()}_breakStart`, now.toISOString());
      alert("Break started.");
    }

    function endBreak() {
      const breakStart = localStorage.getItem(`${getTodayKey()}_breakStart`);
      if (!breakStart) {
        alert("No break in progress.");
        return;
      }
      const now = new Date();
      const prevBreak = parseFloat(localStorage.getItem(`${getTodayKey()}_break`) || "0");
      const breakTime = (now - new Date(breakStart)) / (1000 * 60 * 60);
      localStorage.setItem(`${getTodayKey()}_break`, (prevBreak + breakTime).toFixed(2));
      localStorage.removeItem(`${getTodayKey()}_breakStart`);
      alert(`Break ended: ${breakTime.toFixed(2)} hrs`);
      updateDisplay();
    }

    function saveNote() {
      const note = document.getElementById("taskNote").value.trim();
      localStorage.setItem(`${getTodayKey()}_note`, note);
      alert("Note saved.");
    }

    function updateDisplay() {
      const today = getTodayKey();
      const start = localStorage.getItem(`${today}_start`);
      const end = localStorage.getItem(`${today}_end`);
      const breakTime = parseFloat(localStorage.getItem(`${today}_break`) || "0");
      const note = localStorage.getItem(`${today}_note`) || "";

      document.getElementById("startTime").textContent = start ? formatTime(new Date(start)) : '--:--';
      document.getElementById("endTime").textContent = end ? formatTime(new Date(end)) : '--:--';
      document.getElementById("breakTotal").textContent = breakTime.toFixed(2) + ' hrs';
      document.getElementById("taskNote").value = note;

      if (start && end) {
        const workHours = (new Date(end) - new Date(start)) / (1000 * 60 * 60);
        const net = workHours - breakTime;
        document.getElementById("dailyTotal").textContent = net.toFixed(2) + ' hrs';
      } else {
        document.getElementById("dailyTotal").textContent = '--';
      }

      updateWeeklyTotal();
    }

    function updateWeeklyTotal() {
      const now = new Date();
      let totalHours = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0,10);
        const s = localStorage.getItem(`${key}_start`);
        const e = localStorage.getItem(`${key}_end`);
        const b = parseFloat(localStorage.getItem(`${key}_break`) || "0");
        if (s && e) {
          const h = (new Date(e) - new Date(s)) / (1000 * 60 * 60) - b;
          totalHours += h;
        }
      }
      document.getElementById("weeklyTotal").textContent = totalHours.toFixed(2) + ' hrs';
      const overtimeEl = document.getElementById("overtime");
      if (totalHours > 44) {
        overtimeEl.textContent = '‚ö†Ô∏è OVERTIME';
        overtimeEl.className = 'overtime';
      } else {
        overtimeEl.textContent = '';
        overtimeEl.className = '';
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    function clearData() {
      if (confirm("Clear ALL data including PIN and logs?")) {
        localStorage.clear();
        location.reload();
      }
    }

    function resetCurrentWeek() {
      if (!confirm("Reset current week's time entries only?")) return;
      const now = new Date();
      for (let i = 0; i < 7; i++) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0,10);
        ["_start", "_end", "_break", "_breakStart", "_note"].forEach(suffix => {
          localStorage.removeItem(key + suffix);
        });
      }
      alert("Current week's time cleared.");
      updateDisplay();
    }

    function exportCSV() {
      let csv = "Date,Start,End,Break Hrs,Net Hrs,Note\n";
      const now = new Date();
      for (let i = 0; i < 30; i++) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0,10);
        const s = localStorage.getItem(`${key}_start`);
        const e = localStorage.getItem(`${key}_end`);
        const b = parseFloat(localStorage.getItem(`${key}_break`) || "0");
        const n = localStorage.getItem(`${key}_note`) || "";
        let net = "";
        if (s && e) {
          net = ((new Date(e) - new Date(s)) / (1000 * 60 * 60) - b).toFixed(2);
        }
        csv += `${key},${s ? formatTime(new Date(s)) : ""},${e ? formatTime(new Date(e)) : ""},${b.toFixed(2)},${net},"${n.replace(/"/g, '""')}"\n`;
      }
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "time-tracker.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
